# -*- coding: utf-8 -*-
"""Do An QL CAFE - KPDL

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1aghu0ZaoVdeKA66MuAsoDgrfajKXP9vg
"""

# Äá»c file CSV
# Cháº¡y cÃ¡c file Ä‘á»ƒ sá»­ dá»¥ng mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh

# DonHang (CÃ¡i nÃ y nhÃ¡p. Tui cháº¡y tÃ¬m sp Ä‘i kÃ¨m thui -- Tui lÃ m lá»™n :v)

# Chá»§ yáº¿u cháº¡y cÃ¡c file csv nÃ y --> Rá»“i sáº½ in ra cÃ¡c file csv

# File csv gá»‘c --> File csv sau khi dá»± Ä‘oÃ¡n giÃ¡
# ChiPhiSPDuKien --> gia_ban_du_kien.csv
# GiaBanCua1SoCuaHang --> gia_ban_du_kien_tu_CH_canh_tranh.csv
# DuLieuBanHang --> gia_ban_du_kien_sau_4_thang.csv
# KyNghi --> khuyen_mai_ngay_le.csv

# --> Tá»« Ä‘Ã³ láº¥y cÃ¡c file csv Ä‘Æ°á»£c táº¡o ra
# --> Há»“i quy tuyáº¿n tÃ­nh láº§n ná»¯a Ä‘á»ƒ Ä‘Æ°a ra má»©c giÃ¡ phÃ¹ há»£p nháº¥t

"""================== TÃ¬m SP Ä‘i kÃ¨m ================"""

# 1. ====================== Báº±ng apriori tÃ¬m ra cÃ¡c táº­p phá»• biáº¿n  =====================

# Tá»« file DonHang.csv

import pandas as pd
from mlxtend.frequent_patterns import apriori, association_rules

# Äá»c dá»¯ liá»‡u tá»« file CSV
df = pd.read_csv('DonHang.csv')

# Hiá»ƒn thá»‹ sá»‘ Ä‘Æ¡n hÃ ng
print(f"Sá»‘ Ä‘Æ¡n hÃ ng: {df['MaDonHang'].nunique()}")

# Táº¡o ma tráº­n Ä‘Æ¡n hÃ ng - sáº£n pháº©m (1 náº¿u cÃ³ mua, 0 náº¿u khÃ´ng)
basket = df.groupby(['MaDonHang', 'Ma SP'])['SoLuong'].sum().unstack().fillna(0)
basket = basket.applymap(lambda x: 1 if x > 0 else 0)

# Ãp dá»¥ng thuáº­t toÃ¡n Apriori Ä‘á»ƒ tÃ¬m cÃ¡c táº­p phá»• biáº¿n
frequent_itemsets = apriori(basket, min_support=0.1, use_colnames=True)

# Kiá»ƒm tra náº¿u khÃ´ng tÃ¬m tháº¥y táº­p phá»• biáº¿n nÃ o
if frequent_itemsets.empty:
    print("âŒ KhÃ´ng tÃ¬m tháº¥y táº­p phá»• biáº¿n nÃ o vá»›i min_support Ä‘Ã£ chá»n.")
else:
    print("\nâœ… CÃ¡c táº­p phá»• biáº¿n:")
    print(frequent_itemsets)

    # Táº¡o luáº­t káº¿t há»£p
    rules = association_rules(frequent_itemsets, metric="lift", min_threshold=1)

    print("\nâœ… CÃ¡c luáº­t káº¿t há»£p:")
    print(rules[['antecedents', 'consequents', 'support', 'confidence', 'lift']])

    # === PHáº¦N Lá»ŒC THEO Sáº¢N PHáº¨M ===
    sp_target = input("\nğŸ” Nháº­p mÃ£ sáº£n pháº©m cáº§n tÃ¬m (vÃ­ dá»¥: SP01): ").strip()

    # Lá»c táº­p phá»• biáº¿n chá»©a sáº£n pháº©m
    related_itemsets = frequent_itemsets[frequent_itemsets['itemsets'].apply(lambda x: sp_target in x)]
    print(f"\nğŸ“¦ CÃ¡c táº­p phá»• biáº¿n cÃ³ chá»©a '{sp_target}':")
    print(related_itemsets)

    # Lá»c luáº­t káº¿t há»£p liÃªn quan Ä‘áº¿n sáº£n pháº©m
    related_rules = rules[
        rules['antecedents'].apply(lambda x: sp_target in x) |
        rules['consequents'].apply(lambda x: sp_target in x)
    ]

    print(f"\nğŸ”— CÃ¡c luáº­t káº¿t há»£p liÃªn quan Ä‘áº¿n '{sp_target}':")
    print(related_rules[['antecedents', 'consequents', 'support', 'confidence', 'lift']])

import pandas as pd
from mlxtend.preprocessing import TransactionEncoder
from mlxtend.frequent_patterns import apriori, association_rules
from collections import defaultdict

# BÆ°á»›c 1: Äá»c dá»¯ liá»‡u tá»« file CSV
df = pd.read_csv('DonHang.csv')

# BÆ°á»›c 2: Gom nhÃ³m sáº£n pháº©m theo Ä‘Æ¡n hÃ ng thÃ nh danh sÃ¡ch giao dá»‹ch
donhang_dict = defaultdict(list)
for _, row in df.iterrows():
    donhang_dict[row['MaDonHang']].append(row['Ma SP'])

transactions = list(donhang_dict.values())

print("ğŸ›’ Danh sÃ¡ch cÃ¡c giao dá»‹ch:")
for t in transactions:
    print(t)

# BÆ°á»›c 3: MÃ£ hÃ³a dá»¯ liá»‡u giao dá»‹ch
te = TransactionEncoder()
te_ary = te.fit(transactions).transform(transactions)
df_encoded = pd.DataFrame(te_ary, columns=te.columns_)

# BÆ°á»›c 4: Ãp dá»¥ng thuáº­t toÃ¡n Apriori
frequent_itemsets = apriori(df_encoded, min_support=0.1, use_colnames=True)

# BÆ°á»›c 5: In ra cÃ¡c táº­p phá»• biáº¿n
print("\nâœ… CÃ¡c táº­p phá»• biáº¿n tÃ¬m Ä‘Æ°á»£c:")
print(frequent_itemsets)

# BÆ°á»›c 6: Lá»c theo MASP (mÃ£ sáº£n pháº©m cá»¥ thá»ƒ)
masp = input("\nğŸ” Nháº­p mÃ£ sáº£n pháº©m cáº§n tÃ¬m (vÃ­ dá»¥: SP01): ").strip()
related_itemsets = frequent_itemsets[frequent_itemsets['itemsets'].apply(lambda x: masp in x)]

print(f"\nğŸ“¦ CÃ¡c táº­p phá»• biáº¿n cÃ³ liÃªn quan Ä‘áº¿n '{masp}':")
print(related_itemsets)

# BÆ°á»›c 7: Sinh luáº­t káº¿t há»£p vÃ  lá»c theo MASP
rules = association_rules(frequent_itemsets, metric="lift", min_threshold=1)

related_rules = rules[
    rules['antecedents'].apply(lambda x: masp in x) |
    rules['consequents'].apply(lambda x: masp in x)
]

print(f"\nğŸ”— CÃ¡c luáº­t káº¿t há»£p liÃªn quan Ä‘áº¿n '{masp}':")
print(related_rules[['antecedents', 'consequents', 'support', 'confidence', 'lift']])

""" =============== Dá»± Ä‘oÃ¡n giÃ¡ =================="""

# 2. ================= Dá»¯ Ä‘oÃ¡n giÃ¡ bÃ¡n dá»± kiáº¿n báº±ng mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh ==================

# sá»­ dá»¥ng mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh Ä‘á»ƒ dá»± Ä‘oÃ¡n "GiÃ¡ BÃ¡n Dá»± Kiáº¿n" cho tá»«ng sáº£n pháº©m cÃ³ trong file CSV

# Äá»c dá»¯ liá»‡u tá»« file ChiPhiSPDuKien_csv.csv

1. Äá»c dá»¯ liá»‡u: Äá»c dá»¯ liá»‡u tá»« file ChiPhiSPDuKien_csv.csv.
2. Xá»­ lÃ½ dá»¯ liá»‡u:
3. Äá»•i tÃªn cá»™t 'Khuyen Mai(%)' thÃ nh 'Khuyen Mai (%)' vÃ  'Danh Gia(%)' thÃ nh 'Danh Gia (%)'.
4. Chá»n cÃ¡c cá»™t chi phÃ­, khuyáº¿n mÃ£i, Ä‘Ã¡nh giÃ¡ lÃ m features vÃ  'Gia Ban Du Kien' lÃ m target.
5. Loáº¡i bá» cÃ¡c hÃ ng cÃ³ giÃ¡ trá»‹ khÃ´ng pháº£i sá»‘ trong cÃ¡c cá»™t features vÃ  target.
6. Loáº¡i bá» cÃ¡c hÃ ng cÃ³ giÃ¡ trá»‹ NaN sau khi chuyá»ƒn Ä‘á»•i kiá»ƒu sá»‘.
7. Chia dá»¯ liá»‡u: Chia dá»¯ liá»‡u thÃ nh táº­p huáº¥n luyá»‡n (80%) vÃ  táº­p kiá»ƒm tra (20%).
8. Huáº¥n luyá»‡n mÃ´ hÃ¬nh: Huáº¥n luyá»‡n mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh trÃªn táº­p huáº¥n luyá»‡n.
9. Dá»± Ä‘oÃ¡n: Dá»± Ä‘oÃ¡n 'Gia Ban Du Kien' cho toÃ n bá»™ dá»¯ liá»‡u sá»­ dá»¥ng mÃ´ hÃ¬nh Ä‘Ã£ huáº¥n luyá»‡n.
10. In káº¿t quáº£: In ra DataFrame chá»©a 'Ma SP' vÃ  giÃ¡ dá»± Ä‘oÃ¡n.
11. ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh: TÃ­nh toÃ¡n vÃ  in ra cÃ¡c chá»‰ sá»‘ Ä‘Ã¡nh giÃ¡ MSE, R-squared vÃ  MAE trÃªn táº­p kiá»ƒm tra.
12. Xuáº¥t file CSV: LÆ°u DataFrame káº¿t quáº£ dá»± Ä‘oÃ¡n vÃ o file gia_ban_du_kien.csv.

import pandas as pd
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error

def xuat_file_csv(df, ten_file, index=False, encoding='utf-8'):
    """
    HÃ m xuáº¥t DataFrame ra file CSV.

    Args:
        df (pd.DataFrame): DataFrame cáº§n xuáº¥t.
        ten_file (str): TÃªn file CSV (vÃ­ dá»¥: 'output.csv').
        index (bool, optional): CÃ³ ghi index cá»§a DataFrame vÃ o file CSV khÃ´ng. Máº·c Ä‘á»‹nh lÃ  False.
        encoding (str, optional): MÃ£ hÃ³a cá»§a file CSV. Máº·c Ä‘á»‹nh lÃ  'utf-8'.
    """
    try:
        df.to_csv(ten_file, index=index, encoding=encoding)
        print(f"ÄÃ£ xuáº¥t thÃ nh cÃ´ng file CSV: '{ten_file}'")
    except Exception as e:
        print(f"ÄÃ£ xáº£y ra lá»—i khi xuáº¥t file CSV: {e}")

# Äá»c dá»¯ liá»‡u tá»« file CSV
try:
    df_input = pd.read_csv('ChiPhiSPDuKien_csv.csv', encoding='utf-8')
except FileNotFoundError:
    print("KhÃ´ng tÃ¬m tháº¥y file ChiPhiSPDuKien_csv.csv. Vui lÃ²ng kiá»ƒm tra láº¡i Ä‘Æ°á»ng dáº«n.")
    exit()

# Äá»•i tÃªn cá»™t cho khá»›p (náº¿u cáº§n)
df_input.rename(columns={'Khuyen Mai(%)': 'Khuyen Mai (%)', 'Danh Gia(%)': 'Danh Gia (%)'}, inplace=True)

# Chá»n cÃ¡c cá»™t lÃ m biáº¿n Ä‘á»™c láº­p (features) vÃ  biáº¿n má»¥c tiÃªu (target)
features = ['Chi Phi Nguyen Lieu', 'Chi Phi Nhan Cong', 'Chi Phi Van Hanh', 'Tong Chi Phi', 'Khuyen Mai (%)', 'Danh Gia (%)']
target = 'Gia Ban Du Kien'

# Loáº¡i bá» cÃ¡c hÃ ng cÃ³ giÃ¡ trá»‹ khÃ´ng pháº£i sá»‘ trong cÃ¡c cá»™t features
for col in features:
    df_input = df_input[pd.to_numeric(df_input[col], errors='coerce').notna()]

# Chuyá»ƒn Ä‘á»•i cá»™t target sang kiá»ƒu sá»‘
df_input = df_input[pd.to_numeric(df_input[target], errors='coerce').notna()]
df_input[target] = pd.to_numeric(df_input[target], errors='coerce')

# Loáº¡i bá» cÃ¡c hÃ ng cÃ³ giÃ¡ trá»‹ NaN sau khi chuyá»ƒn Ä‘á»•i
df_input.dropna(subset=features + [target], inplace=True)

X = df_input[features]
y = df_input[target]

# Chia dá»¯ liá»‡u thÃ nh táº­p huáº¥n luyá»‡n vÃ  táº­p kiá»ƒm tra
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Khá»Ÿi táº¡o vÃ  huáº¥n luyá»‡n mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh
model = LinearRegression()
model.fit(X_train, y_train)

# Dá»± Ä‘oÃ¡n giÃ¡ bÃ¡n dá»± kiáº¿n cho Táº¤T Cáº¢ sáº£n pháº©m trong file
y_pred_all = model.predict(X)

# Táº¡o má»™t DataFrame má»›i chá»©a Ma SP vÃ  GiÃ¡ BÃ¡n Dá»± Kiáº¿n Ä‘Ã£ dá»± Ä‘oÃ¡n
df_predicted = pd.DataFrame({'MaSP': df_input['Ma SP'], 'Gia Ban Du Kien': y_pred_all})

# In ra DataFrame chá»©a Ma SP vÃ  giÃ¡ dá»± Ä‘oÃ¡n
print("GiÃ¡ bÃ¡n dá»± kiáº¿n dá»± Ä‘oÃ¡n cho tá»«ng sáº£n pháº©m:")
print(df_predicted)

# ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh trÃªn táº­p kiá»ƒm tra
y_pred_test = model.predict(X_test)
mse = mean_squared_error(y_test, y_pred_test)
print(f'Mean Squared Error trÃªn táº­p kiá»ƒm tra: {mse:.2f}\n')

print("\nÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh:")
print(f"Mean Squared Error (MSE) trÃªn táº­p kiá»ƒm tra: {mse:.2f}")

# Äá»ƒ cÃ³ thÃªm cÃ¡c chá»‰ sá»‘ Ä‘Ã¡nh giÃ¡, báº¡n cÃ³ thá»ƒ import thÃªm cÃ¡c hÃ m tá»« sklearn.metrics
from sklearn.metrics import r2_score, mean_absolute_error

r2 = r2_score(y_test, y_pred_test)
mae = mean_absolute_error(y_test, y_pred_test)

print(f"R-squared (R^2) trÃªn táº­p kiá»ƒm tra: {r2:.2f}")
print(f"Mean Absolute Error (MAE) trÃªn táº­p kiá»ƒm tra: {mae:.2f}")

# Sá»­ dá»¥ng hÃ m xuat_file_csv Ä‘á»ƒ xuáº¥t DataFrame káº¿t quáº£ ra file CSV
ten_file_xuat = 'gia_ban_du_kien.csv'
xuat_file_csv(df_predicted, ten_file_xuat)

# ================= GiÃ¡ bÃ¡n cá»§a 1 sá»‘ cá»­a hÃ ng Äá»I THá»¦ Cáº NH TRANH ================

# Ä‘á»c sá»¯ liá»‡u tá»« file GiaBanCua1SoCuaHang_csv.csv

# sá»­ dá»¥ng mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh Ä‘á»ƒ dá»± Ä‘oÃ¡n "GiÃ¡ BÃ¡n" cho tá»«ng sáº£n pháº©m cÃ³ trong file CSV

1. Äá»c dá»¯ liá»‡u: Äá»c dá»¯ liá»‡u tá»« file GiaBanCua1SoCuaHang_csv.csv.
2. Xá»­ lÃ½ dá»¯ liá»‡u:
3. Thay tháº¿ giÃ¡ trá»‹ 'k' báº±ng NaN trong cá»™t 'GiaBanCuaHang 20'.
4. Chuyá»ƒn Ä‘á»•i cÃ¡c cá»™t giÃ¡ sang kiá»ƒu sá»‘ vÃ  loáº¡i bá» cÃ¡c hÃ ng chá»©a NaN.
5. Chá»n features vÃ  target: Chá»n 'GiaBanCuaHang 1' lÃ m target vÃ  cÃ¡c cá»™t giÃ¡ cÃ²n láº¡i lÃ m features.
6. Chia dá»¯ liá»‡u: Chia dá»¯ liá»‡u thÃ nh táº­p huáº¥n luyá»‡n vÃ  táº­p kiá»ƒm tra.
7. Huáº¥n luyá»‡n mÃ´ hÃ¬nh: Huáº¥n luyá»‡n mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh.
8. Dá»± Ä‘oÃ¡n: Dá»± Ä‘oÃ¡n giÃ¡ bÃ¡n phÃ¹ há»£p cho táº¥t cáº£ cÃ¡c sáº£n pháº©m Ä‘Ã£ lÃ m sáº¡ch dá»±a trÃªn mÃ´ hÃ¬nh.
9. ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh: TÃ­nh toÃ¡n MSE, R-squared vÃ  MAE trÃªn táº­p kiá»ƒm tra vÃ  Ä‘Æ°a ra má»™t Ä‘Ã¡nh giÃ¡ sÆ¡ bá»™.
10. Xuáº¥t file CSV: LÆ°u káº¿t quáº£ dá»± Ä‘oÃ¡n vÃ o file gia_ban_du_kien_tu_CH_canh_tranh.csv

import pandas as pd
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error, r2_score, mean_absolute_error

def xuat_file_csv(df, ten_file, index=False, encoding='utf-8'):
    """
    HÃ m xuáº¥t DataFrame ra file CSV.

    Args:
        df (pd.DataFrame): DataFrame cáº§n xuáº¥t.
        ten_file (str): TÃªn file CSV (vÃ­ dá»¥: 'output.csv').
        index (bool, optional): CÃ³ ghi index cá»§a DataFrame vÃ o file CSV khÃ´ng. Máº·c Ä‘á»‹nh lÃ  False.
        encoding (str, optional): MÃ£ hÃ³a cá»§a file CSV. Máº·c Ä‘á»‹nh lÃ  'utf-8'.
    """
    try:
        df.to_csv(ten_file, index=index, encoding=encoding)
        print(f"ÄÃ£ xuáº¥t thÃ nh cÃ´ng file CSV: '{ten_file}'")
    except Exception as e:
        print(f"ÄÃ£ xáº£y ra lá»—i khi xuáº¥t file CSV: {e}")

# TÃªn file CSV
file_path = 'GiaBanCua1SoCuaHang_csv.csv'

try:
    # Äá»c dá»¯ liá»‡u tá»« file CSV vá»›i dáº¥u phÃ¢n cÃ¡ch lÃ  dáº¥u pháº©y
    df = pd.read_csv(file_path, sep=',')

    # Thay tháº¿ giÃ¡ trá»‹ 'k' trong cá»™t 'GiaBanCuaHang 20' báº±ng NaN
    df['GiaBanCuaHang 20'] = df['GiaBanCuaHang 20'].replace('k', pd.NA)

    # Chuyá»ƒn Ä‘á»•i táº¥t cáº£ cÃ¡c cá»™t giÃ¡ sang kiá»ƒu sá»‘ (Ã©p buá»™c lá»—i thÃ nh NaN)
    gia_cua_hang_cols = [col for col in df.columns if col != 'MaSP']
    for col in gia_cua_hang_cols:
        df[col] = pd.to_numeric(df[col], errors='coerce')

    df_cleaned = df.dropna()

    if not df_cleaned.empty and len(gia_cua_hang_cols) > 1:
        # Chá»n cá»™t má»¥c tiÃªu vÃ  cÃ¡c features
        target_col = 'GiaBanCuaHang 1'
        feature_cols = [col for col in gia_cua_hang_cols if col != target_col]

        X = df_cleaned[feature_cols]
        y = df_cleaned[target_col]

        # Chia dá»¯ liá»‡u thÃ nh táº­p huáº¥n luyá»‡n vÃ  kiá»ƒm tra
        X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

        # Huáº¥n luyá»‡n mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh
        model = LinearRegression()
        model.fit(X_train, y_train)

        # Dá»± Ä‘oÃ¡n "GiÃ¡ BÃ¡n" phÃ¹ há»£p dá»±a trÃªn giÃ¡ cá»§a táº¥t cáº£ cÃ¡c Ä‘á»‘i thá»§
        # ChÃºng ta sáº½ sá»­ dá»¥ng toÃ n bá»™ dá»¯ liá»‡u Ä‘Ã£ lÃ m sáº¡ch Ä‘á»ƒ dá»± Ä‘oÃ¡n
        X_all = df_cleaned[feature_cols]
        predicted_gia_ban = model.predict(X_all)

        df_gia_ban_du_kien = pd.DataFrame({'MaSP': df_cleaned['MaSP'], 'GiaBanPhuHop': predicted_gia_ban})
        print("\nGiÃ¡ BÃ¡n PhÃ¹ Há»£p Dá»± Kiáº¿n (dá»±a trÃªn mÃ´ hÃ¬nh há»“i quy):")
        print(df_gia_ban_du_kien)

        # ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh (trÃªn táº­p kiá»ƒm tra)
        y_pred_test = model.predict(X_test)
        mse = mean_squared_error(y_test, y_pred_test)
        r2 = r2_score(y_test, y_pred_test)
        mae = mean_absolute_error(y_test, y_pred_test)

        print("\nÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh trÃªn táº­p kiá»ƒm tra:")
        print(f'Mean Squared Error (MSE): {mse:.2f}')
        print(f'R-squared (R^2): {r2:.2f}')
        print(f'Mean Absolute Error (MAE): {mae:.2f}')

        # ÄÃ¡nh giÃ¡ tá»‘t/xáº¥u (mang tÃ­nh tÆ°Æ¡ng Ä‘á»‘i)
        print("\nÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh:")
        if r2 > 0.7:
            print("MÃ´ hÃ¬nh cÃ³ váº» phÃ¹ há»£p tá»‘t vá»›i dá»¯ liá»‡u (R-squared cao).")
        elif r2 > 0.5:
            print("MÃ´ hÃ¬nh á»Ÿ má»©c cháº¥p nháº­n Ä‘Æ°á»£c.")
        else:
            print("MÃ´ hÃ¬nh cÃ³ thá»ƒ chÆ°a phÃ¹ há»£p tá»‘t.")

        if mae < (y_test.max() - y_test.min()) / 10:  # Æ¯á»›c tÃ­nh má»™t ngÆ°á»¡ng tÆ°Æ¡ng Ä‘á»‘i
            print("Sai sá»‘ trung bÃ¬nh tuyá»‡t Ä‘á»‘i (MAE) tÆ°Æ¡ng Ä‘á»‘i nhá».")
        else:
            print("Sai sá»‘ trung bÃ¬nh tuyá»‡t Ä‘á»‘i (MAE) cÃ³ thá»ƒ cáº§n Ä‘Æ°á»£c cáº£i thiá»‡n.")

        # Xuáº¥t DataFrame df_gia_ban_du_kien ra file CSV
        ten_file_xuat = 'gia_ban_du_kien_tu_CH_canh_tranh.csv'
        xuat_file_csv(df_gia_ban_du_kien, ten_file_xuat)

    else:
        print("\nKhÃ´ng Ä‘á»§ dá»¯ liá»‡u hoáº·c cá»™t Ä‘á»ƒ thá»±c hiá»‡n há»“i quy.")

except FileNotFoundError:
    print(f"KhÃ´ng tÃ¬m tháº¥y file: {file_path}. Vui lÃ²ng kiá»ƒm tra láº¡i tÃªn file vÃ  Ä‘Æ°á»ng dáº«n.")
except Exception as e:
    print(f"ÄÃ£ xáº£y ra lá»—i: {e}")

# ================= Sá»‘ lÆ°á»£ng khÃ¡ch mua bÃ¡n sáº£n pháº©m trong 4 thÃ¡ng ================

# Ä‘á»c sá»¯ liá»‡u tá»« file DuLieuBanHang_csv.csv

# sá»­ dá»¥ng mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh Ä‘á»ƒ dá»± Ä‘oÃ¡n "GiÃ¡ BÃ¡n" cho tá»«ng sáº£n pháº©m cÃ³ trong file CSV

1. Äá»c dá»¯ liá»‡u: Äá»c dá»¯ liá»‡u tá»« file DuLieuBanHang_csv.csv.
2. Äá»•i tÃªn cá»™t: Äá»•i tÃªn cá»™t 'SanPham' thÃ nh 'MaSP' vÃ  'SoLuongBan' thÃ nh 'SoLuongBan'.
3. Chá»n features vÃ  target: Chá»n 'SoLuongBan' lÃ m feature duy nháº¥t vÃ  'GiaBan' lÃ m target.
4. Dá»± Ä‘oÃ¡n theo tá»«ng sáº£n pháº©m:
5. Láº·p qua tá»«ng sáº£n pháº©m duy nháº¥t ('MaSP').
6. Vá»›i má»—i sáº£n pháº©m, náº¿u cÃ³ nhiá»u hÆ¡n má»™t dÃ²ng dá»¯ liá»‡u, nÃ³ sáº½ huáº¥n luyá»‡n má»™t mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh riÃªng biá»‡t Ä‘á»ƒ dá»± Ä‘oÃ¡n 'GiaBan' dá»±a trÃªn 'SoLuongBan'. GiÃ¡ dá»± Ä‘oÃ¡n Ä‘Æ°á»£c tÃ­nh dá»±a trÃªn sá»‘ lÆ°á»£ng bÃ¡n trung bÃ¬nh cá»§a sáº£n pháº©m Ä‘Ã³.
7. Náº¿u chá»‰ cÃ³ má»™t dÃ²ng dá»¯ liá»‡u cho sáº£n pháº©m, giÃ¡ dá»± Ä‘oÃ¡n sáº½ lÃ  giÃ¡ bÃ¡n thá»±c táº¿ cá»§a dÃ²ng Ä‘Ã³.
8. Náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u cho sáº£n pháº©m, giÃ¡ dá»± Ä‘oÃ¡n sáº½ lÃ  None.
9. In káº¿t quáº£: In ra DataFrame chá»©a 'MaSP' vÃ  'GiaBanDuDoan'.
10. Xuáº¥t file CSV: LÆ°u káº¿t quáº£ vÃ o file gia_ban_du_kien_sau_4_thang.csv.

import pandas as pd
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error
import warnings

# Bá» qua UserWarning vÃ  FutureWarning
warnings.filterwarnings("ignore", category=UserWarning)
warnings.filterwarnings("ignore", category=FutureWarning)

def xuat_file_csv(df, ten_file, index=False, encoding='utf-8'):
    """
    HÃ m xuáº¥t DataFrame ra file CSV.

    Args:
        df (pd.DataFrame): DataFrame cáº§n xuáº¥t.
        ten_file (str): TÃªn file CSV (vÃ­ dá»¥: 'output.csv').
        index (bool, optional): CÃ³ ghi index cá»§a DataFrame vÃ o file CSV khÃ´ng. Máº·c Ä‘á»‹nh lÃ  False.
        encoding (str, optional): MÃ£ hÃ³a cá»§a file CSV. Máº·c Ä‘á»‹nh lÃ  'utf-8'.
    """
    try:
        df.to_csv(ten_file, index=index, encoding=encoding)
        print(f"ÄÃ£ xuáº¥t thÃ nh cÃ´ng file CSV: '{ten_file}'")
    except Exception as e:
        print(f"ÄÃ£ xáº£y ra lá»—i khi xuáº¥t file CSV: {e}")

# TÃªn file CSV
ten_file = 'DuLieuBanHang_csv.csv'

try:
    # Äá»c dá»¯ liá»‡u tá»« file CSV
    df = pd.read_csv(ten_file)
    df.rename(columns={'SanPham': 'MaSP', 'SoLuongBan': 'SoLuongBan'}, inplace=True)

    # CÃ¡c biáº¿n Ä‘á»™c láº­p (features) cÃ³ thá»ƒ áº£nh hÆ°á»Ÿng Ä‘áº¿n giÃ¡
    cac_cot_dau_vao = ['SoLuongBan']
    cot_muc_tieu = 'GiaBan'

    # Táº¡o DataFrame Ä‘á»ƒ lÆ°u giÃ¡ dá»± Ä‘oÃ¡n cho tá»«ng sáº£n pháº©m
    df_gia_du_doan = pd.DataFrame(columns=['MaSP', 'GiaBanDuDoan'])

    # Láº·p qua tá»«ng sáº£n pháº©m duy nháº¥t
    for ma_sp in df['MaSP'].unique():
        df_sp = df[df['MaSP'] == ma_sp].dropna(subset=cac_cot_dau_vao + [cot_muc_tieu])

        if len(df_sp) > 1:
            X = df_sp[cac_cot_dau_vao]
            y = df_sp[cot_muc_tieu]

            model = LinearRegression()
            model.fit(X, y)

            so_luong_ban_tb = df_sp['SoLuongBan'].mean()
            gia_ban_du_doan = model.predict([[so_luong_ban_tb]])[0]

            df_gia_du_doan = pd.concat([df_gia_du_doan, pd.DataFrame([{'MaSP': ma_sp, 'GiaBanDuDoan': gia_ban_du_doan}])], ignore_index=True)

        elif not df_sp.empty:
            gia_ban_thuc_te = df_sp['GiaBan'].iloc[0]
            df_gia_du_doan = pd.concat([df_gia_du_doan, pd.DataFrame([{'MaSP': ma_sp, 'GiaBanDuDoan': gia_ban_thuc_te}])], ignore_index=True)
        else:
            df_gia_du_doan = pd.concat([df_gia_du_doan, pd.DataFrame([{'MaSP': ma_sp, 'GiaBanDuDoan': None}])], ignore_index=True)

    print("\nGiÃ¡ BÃ¡n Dá»± ÄoÃ¡n (dá»±a trÃªn há»“i quy tuyáº¿n tÃ­nh theo tá»«ng sáº£n pháº©m):")
    print(df_gia_du_doan)

    # Xuáº¥t DataFrame df_gia_du_doan ra file CSV
    ten_file_xuat = 'gia_ban_du_kien_sau_4_thang.csv'
    xuat_file_csv(df_gia_du_doan, ten_file_xuat)

except FileNotFoundError:
    print(f"KhÃ´ng tÃ¬m tháº¥y file: {ten_file}. Vui lÃ²ng kiá»ƒm tra láº¡i tÃªn file vÃ  Ä‘Æ°á»ng dáº«n.")
except Exception as e:
    print(f"ÄÃ£ xáº£y ra lá»—i: {e}")

# ÄÆ°a ra Ä‘Ã¡nh giÃ¡ mÃ´ hÃ¬nh ---- NhÃ¡p ----
import pandas as pd
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error, r2_score, mean_absolute_error
import warnings

# Bá» qua UserWarning vÃ  FutureWarning
warnings.filterwarnings("ignore", category=UserWarning)
warnings.filterwarnings("ignore", category=FutureWarning)

def xuat_file_csv(df, ten_file, index=False, encoding='utf-8'):
    """
    HÃ m xuáº¥t DataFrame ra file CSV.

    Args:
        df (pd.DataFrame): DataFrame cáº§n xuáº¥t.
        ten_file (str): TÃªn file CSV (vÃ­ dá»¥: 'output.csv').
        index (bool, optional): CÃ³ ghi index cá»§a DataFrame vÃ o file CSV khÃ´ng. Máº·c Ä‘á»‹nh lÃ  False.
        encoding (str, optional): MÃ£ hÃ³a cá»§a file CSV. Máº·c Ä‘á»‹nh lÃ  'utf-8'.
    """
    try:
        df.to_csv(ten_file, index=index, encoding=encoding)
        print(f"ÄÃ£ xuáº¥t thÃ nh cÃ´ng file CSV: '{ten_file}'")
    except Exception as e:
        print(f"ÄÃ£ xáº£y ra lá»—i khi xuáº¥t file CSV: {e}")

def danh_gia_mo_hinh(y_true, y_pred, ma_sp):
    mse = mean_squared_error(y_true, y_pred)
    r2 = r2_score(y_true, y_pred)
    mae = mean_absolute_error(y_true, y_pred)
    print(f"\nÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh cho sáº£n pháº©m {ma_sp}:")
    print(f"  Mean Squared Error (MSE): {mse:.2f}")
    print(f"  R-squared (R^2): {r2:.2f}")
    print(f"  Mean Absolute Error (MAE): {mae:.2f}")
    if r2 > 0.7:
        print("  MÃ´ hÃ¬nh cÃ³ váº» phÃ¹ há»£p tá»‘t.")
    elif r2 > 0.5:
        print("  MÃ´ hÃ¬nh á»Ÿ má»©c cháº¥p nháº­n Ä‘Æ°á»£c.")
    else:
        print("  MÃ´ hÃ¬nh cÃ³ thá»ƒ chÆ°a phÃ¹ há»£p tá»‘t.")

# TÃªn file CSV
ten_file = 'DuLieuBanHang_csv.csv'

try:
    # Äá»c dá»¯ liá»‡u tá»« file CSV
    df = pd.read_csv(ten_file)
    df.rename(columns={'SanPham': 'MaSP', 'SoLuongBan': 'SoLuongBan'}, inplace=True)

    # CÃ¡c biáº¿n Ä‘á»™c láº­p (features) cÃ³ thá»ƒ áº£nh hÆ°á»Ÿng Ä‘áº¿n giÃ¡
    cac_cot_dau_vao = ['SoLuongBan']
    cot_muc_tieu = 'GiaBan'

    # Táº¡o DataFrame Ä‘á»ƒ lÆ°u giÃ¡ dá»± Ä‘oÃ¡n cho tá»«ng sáº£n pháº©m
    df_gia_du_doan = pd.DataFrame(columns=['MaSP', 'GiaBanDuDoan'])

    # Láº·p qua tá»«ng sáº£n pháº©m duy nháº¥t
    for ma_sp in df['MaSP'].unique():
        df_sp = df[df['MaSP'] == ma_sp].dropna(subset=cac_cot_dau_vao + [cot_muc_tieu])

        if len(df_sp) > 5:  # Cáº§n Ã­t nháº¥t vÃ i Ä‘iá»ƒm dá»¯ liá»‡u Ä‘á»ƒ chia train/test cÃ³ Ã½ nghÄ©a
            X = df_sp[cac_cot_dau_vao]
            y = df_sp[cot_muc_tieu]
            X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

            model = LinearRegression()
            model.fit(X_train, y_train)

            y_pred = model.predict(X_test)
            danh_gia_mo_hinh(y_test, y_pred, ma_sp)

            so_luong_ban_tb = df_sp['SoLuongBan'].mean()
            gia_ban_du_doan = model.predict([[so_luong_ban_tb]])[0]
            df_gia_du_doan = pd.concat([df_gia_du_doan, pd.DataFrame([{'MaSP': ma_sp, 'GiaBanDuDoan': gia_ban_du_doan}])], ignore_index=True)

        elif not df_sp.empty:
            gia_ban_thuc_te = df_sp['GiaBan'].iloc[0]
            df_gia_du_doan = pd.concat([df_gia_du_doan, pd.DataFrame([{'MaSP': ma_sp, 'GiaBanDuDoan': gia_ban_thuc_te}])], ignore_index=True)
        else:
            df_gia_du_doan = pd.concat([df_gia_du_doan, pd.DataFrame([{'MaSP': ma_sp, 'GiaBanDuDoan': None}])], ignore_index=True)

    print("\nGiÃ¡ BÃ¡n Dá»± ÄoÃ¡n (dá»±a trÃªn há»“i quy tuyáº¿n tÃ­nh theo tá»«ng sáº£n pháº©m):")
    print(df_gia_du_doan)

    # Xuáº¥t DataFrame df_gia_du_doan ra file CSV
    ten_file_xuat = 'gia_ban_du_kien_sau_4_thang.csv'
    xuat_file_csv(df_gia_du_doan, ten_file_xuat)

except FileNotFoundError:
    print(f"KhÃ´ng tÃ¬m tháº¥y file: {ten_file}. Vui lÃ²ng kiá»ƒm tra láº¡i tÃªn file vÃ  Ä‘Æ°á»ng dáº«n.")
except Exception as e:
    print(f"ÄÃ£ xáº£y ra lá»—i: {e}")

# ================= ÄÆ°a ra má»©c % khuyáº¿n mÃ£i vÃ o cÃ¡c ngÃ y Lá»… ================

# Ä‘á»c dá»¯ liá»‡u tá»« file KyNghi.csv

# sá»­ dá»¥ng mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh Ä‘á»ƒ dá»± Ä‘oÃ¡n "% khuyáº¿n mÃ£i" cho cÃ¡c ngÃ y lá»… cÃ³ trong file CSV

import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error

# Äá»c file CSV
try:
    df = pd.read_csv('KyNghi.csv')
except FileNotFoundError:
    print("Lá»—i: KhÃ´ng tÃ¬m tháº¥y file KyNghi.csv. Vui lÃ²ng Ä‘áº£m báº£o file tá»“n táº¡i trong thÆ° má»¥c lÃ m viá»‡c.")
    exit()

# HÃ m táº¡o cá»™t 'Pháº§n trÄƒm khuyáº¿n mÃ£i' dá»±a trÃªn quy táº¯c cho ngÃ y lá»…
def get_promotion(row):
    if pd.notnull(row['Ngay le']) and row['Ngay le'] != 'NULL':
        promotion = (
            row['Cuoi tuan'] * 2 +  # ThÃªm % náº¿u cuá»‘i tuáº§n
            row['Nghi hoc'] * 3 +    # ThÃªm % náº¿u nghá»‰ há»c
            (row['Nhiet do TB'] - 25) * 0.3 + # ThÃªm % theo nhiá»‡t Ä‘á»™ (trÃªn 25)
            row['Ngoai troi'] * 5      # ThÃªm % theo hoáº¡t Ä‘á»™ng ngoÃ i trá»i
        )
        return max(0, promotion) # Äáº£m báº£o khuyáº¿n mÃ£i khÃ´ng Ã¢m
    else:
        return 0.0

df['Pháº§n trÄƒm khuyáº¿n mÃ£i'] = df.apply(get_promotion, axis=1)

# Chuyá»ƒn Ä‘á»•i biáº¿n 'Ngay le' thÃ nh biáº¿n sá»‘ (cho mÃ´ hÃ¬nh)
df['La_Ngay_Le'] = df['Ngay le'].apply(lambda x: 1 if pd.notnull(x) and x != 'NULL' else 0)

# Chá»n cÃ¡c biáº¿n Ä‘á»™c láº­p vÃ  biáº¿n má»¥c tiÃªu
features = ['Cuoi tuan', 'Nghi hoc', 'Nhiet do TB', 'Ngoai troi', 'La_Ngay_Le']
target = 'Pháº§n trÄƒm khuyáº¿n mÃ£i'

# Loáº¡i bá» cÃ¡c dÃ²ng cÃ³ giÃ¡ trá»‹ NaN trong cÃ¡c cá»™t liÃªn quan
df_cleaned = df.dropna(subset=features + [target])

X = df_cleaned[features]
y = df_cleaned[target]

# Chia dá»¯ liá»‡u thÃ nh táº­p huáº¥n luyá»‡n vÃ  táº­p kiá»ƒm tra
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Khá»Ÿi táº¡o vÃ  huáº¥n luyá»‡n mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh trÃªn TOÃ€N Bá»˜ dá»¯ liá»‡u huáº¥n luyá»‡n
model = LinearRegression()
model.fit(X_train, y_train)

# Dá»± Ä‘oÃ¡n pháº§n trÄƒm khuyáº¿n mÃ£i trÃªn táº­p kiá»ƒm tra
y_pred = model.predict(X_test)
mse = mean_squared_error(y_test, y_pred)
print(f'\nMean Squared Error trÃªn táº­p kiá»ƒm tra: {mse}')

# ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh (dá»±a trÃªn MSE)
print("\nÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh (dá»±a trÃªn MSE):")
if mse < 2:
    print("MÃ´ hÃ¬nh cÃ³ váº» Ä‘áº¡t chuáº©n tá»‘t.")
elif mse < 5:
    print("MÃ´ hÃ¬nh á»Ÿ má»©c cháº¥p nháº­n Ä‘Æ°á»£c.")
else:
    print("MÃ´ hÃ¬nh cÃ³ thá»ƒ chÆ°a Ä‘áº¡t chuáº©n.")

# Lá»c ra káº¿t quáº£ dá»± Ä‘oÃ¡n chá»‰ cho cÃ¡c ngÃ y lá»… (Ngay le khÃ¡c NULL) trÃªn táº­p Dá»® LIá»†U Gá»C Ä‘Ã£ lÃ m sáº¡ch
df_le_results = df_cleaned[df_cleaned['Ngay le'].notna() & (df_cleaned['Ngay le'] != 'NULL')].copy()
df_le_results['Pháº§n trÄƒm khuyáº¿n mÃ£i dá»± Ä‘oÃ¡n'] = model.predict(df_le_results[features])

print("\nKáº¿t quáº£ dá»± Ä‘oÃ¡n pháº§n trÄƒm khuyáº¿n mÃ£i cho cÃ¡c ngÃ y lá»…:")
print(df_le_results[['Ngay Thang', 'Ngay le', 'Pháº§n trÄƒm khuyáº¿n mÃ£i', 'Pháº§n trÄƒm khuyáº¿n mÃ£i dá»± Ä‘oÃ¡n']])

# Xuáº¥t káº¿t quáº£ dá»± Ä‘oÃ¡n cho ngÃ y lá»… ra file CSV
output_file = 'khuyen_mai_ngay_le.csv'
df_le_results[['Ngay Thang', 'Ngay le', 'Pháº§n trÄƒm khuyáº¿n mÃ£i dá»± Ä‘oÃ¡n']].to_csv(output_file, index=False)

print(f"\nÄÃ£ xuáº¥t káº¿t quáº£ dá»± Ä‘oÃ¡n khuyáº¿n mÃ£i cho cÃ¡c ngÃ y lá»… ra file: {output_file}")

print("\nCÃ¡c há»‡ sá»‘ cá»§a mÃ´ hÃ¬nh há»“i quy (huáº¥n luyá»‡n trÃªn toÃ n bá»™ dá»¯ liá»‡u):")
coefficients = pd.DataFrame({'Feature': features, 'Coefficient': model.coef_})
print(coefficients)
print(f"\nIntercept: {model.intercept_}")

Cá»™t "Pháº§n trÄƒm khuyáº¿n mÃ£i dá»± Ä‘oÃ¡n" chá»©a káº¿t quáº£ dá»± Ä‘oÃ¡n má»©c pháº§n trÄƒm khuyáº¿n mÃ£i cho tá»«ng ngÃ y
(bao gá»“m cáº£ ngÃ y lá»… vÃ  ngÃ y thÆ°á»ng) mÃ  mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh Ä‘Ã£ Ä‘Æ°a ra sau khi Ä‘Æ°á»£c huáº¥n luyá»‡n.

MÃ´ hÃ¬nh nÃ y Ä‘Ã£ cá»‘ gáº¯ng há»c má»‘i quan há»‡ giá»¯a cÃ¡c features (Cuoi tuan, Nghi hoc, Nhiet do TB, Ngoai troi, La_Ngay_Le)
vÃ  target (cá»™t "Pháº§n trÄƒm khuyáº¿n mÃ£i" mÃ  chÃºng ta Ä‘Ã£ táº¡o dá»±a trÃªn quy táº¯c cho ngÃ y lá»…).

# ======= CHá»T GIÃ BÃN PHÃ™ Há»¢P NHáº¤T CHO SP ========
# 1. Äá»c dá»¯ liá»‡u tá»« cáº£ ba file CSV vÃ o cÃ¡c DataFrame.
# 2. Gá»™p cÃ¡c DataFrame nÃ y láº¡i vá»›i nhau dá»±a trÃªn cá»™t 'MaSP'.
# 3. Chá»n cÃ¡c cá»™t giÃ¡ dá»± Ä‘oÃ¡n lÃ m biáº¿n Ä‘á»™c láº­p (features) vÃ  má»™t trong sá»‘ chÃºng (vÃ­ dá»¥, giÃ¡ tá»« gia_ban_du_kien.csv) lÃ m biáº¿n má»¥c tiÃªu ban Ä‘áº§u Ä‘á»ƒ huáº¥n luyá»‡n mÃ´ hÃ¬nh.
# 4. Huáº¥n luyá»‡n mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh.
# 5. Sá»­ dá»¥ng mÃ´ hÃ¬nh Ä‘Ã£ huáº¥n luyá»‡n Ä‘á»ƒ dá»± Ä‘oÃ¡n má»™t má»©c giÃ¡ má»›i, cÃ³ thá»ƒ dá»±a trÃªn chÃ­nh cÃ¡c features Ä‘Ã³.

import pandas as pd
from sklearn.linear_model import LinearRegression
import numpy as np

# 1. Äá»c dá»¯ liá»‡u tá»« cÃ¡c file CSV
try:
    df_gia_ban = pd.read_csv('gia_ban_du_kien.csv')
    df_canh_tranh = pd.read_csv('gia_ban_du_kien_tu_CH_canh_tranh.csv')
    df_4_thang = pd.read_csv('gia_ban_du_kien_sau_4_thang.csv')
except FileNotFoundError as e:
    print(f"KhÃ´ng tÃ¬m tháº¥y má»™t hoáº·c nhiá»u file CSV: {e}")
    exit()

# Äá»•i tÃªn cá»™t Ä‘á»ƒ dá»… quáº£n lÃ½
df_canh_tranh = df_canh_tranh.rename(columns={'GiaBanPhuHop': 'GiaBan_CanhTranh'})
df_4_thang = df_4_thang.rename(columns={'GiaBanDuDoan': 'GiaBan_4Thang'})
df_gia_ban = df_gia_ban.rename(columns={'Gia Ban Du Kien': 'GiaBan_ChiPhi'})

# 2. Gá»™p cÃ¡c DataFrame láº¡i vá»›i nhau dá»±a trÃªn cá»™t 'MaSP'
df_merged = pd.merge(df_gia_ban[['MaSP', 'GiaBan_ChiPhi']], df_canh_tranh[['MaSP', 'GiaBan_CanhTranh']], on='MaSP', how='outer')
df_merged = pd.merge(df_merged, df_4_thang[['MaSP', 'GiaBan_4Thang']], on='MaSP', how='outer')

# 3. Chá»n táº¥t cáº£ cÃ¡c cá»™t giÃ¡ dá»± Ä‘oÃ¡n lÃ m features
features = ['GiaBan_ChiPhi', 'GiaBan_CanhTranh', 'GiaBan_4Thang']

# Táº¡o má»™t cá»™t má»¥c tiÃªu giáº£ Ä‘á»‹nh (vÃ­ dá»¥, trung bÃ¬nh cá»§a cÃ¡c giÃ¡) Ä‘á»ƒ huáº¥n luyá»‡n
df_merged['GiaTriTrungBinh'] = df_merged[features].mean(axis=1)
target = 'GiaTriTrungBinh'

# Loáº¡i bá» cÃ¡c hÃ ng chá»©a NaN á»Ÿ cÃ¡c cá»™t features vÃ  target
df_final = df_merged.dropna(subset=features + [target])

# Chuáº©n bá»‹ dá»¯ liá»‡u cho mÃ´ hÃ¬nh
X = df_final[features]
y = df_final[target]

# 4. Huáº¥n luyá»‡n mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh
model = LinearRegression()
model.fit(X, y)

# 5. Sá»­ dá»¥ng mÃ´ hÃ¬nh Ä‘Ã£ huáº¥n luyá»‡n Ä‘á»ƒ dá»± Ä‘oÃ¡n má»©c giÃ¡ káº¿t há»£p
gia_ban_du_doan_cuoi = model.predict(X)

# Táº¡o DataFrame káº¿t quáº£
df_result = pd.DataFrame({'MaSP': df_final['MaSP'], 'GiaBanDuDoan': gia_ban_du_doan_cuoi})

# In káº¿t quáº£
print("\nGiÃ¡ bÃ¡n dá»± Ä‘oÃ¡n cuá»‘i cÃ¹ng (dá»±a trÃªn mÃ´ hÃ¬nh há»“i quy tá»« táº¥t cáº£ cÃ¡c giÃ¡):")
print(df_result)

# Táº¡o ná»™i dung file SQL
sql_commands = "-- Báº£ng chá»©a giÃ¡ bÃ¡n dá»± Ä‘oÃ¡n\n"
sql_commands += "CREATE TABLE IF NOT EXISTS gia_du_doan (\n"
sql_commands += "    MaSP TEXT PRIMARY KEY,\n"
sql_commands += "    GiaBanDuDoan REAL\n"
sql_commands += ");\n\n"

sql_commands += "-- XÃ³a dá»¯ liá»‡u cÅ© (náº¿u cáº§n)\n"
sql_commands += "DELETE FROM gia_du_doan;\n\n"

sql_commands += "-- ThÃªm dá»¯ liá»‡u giÃ¡ bÃ¡n dá»± Ä‘oÃ¡n\n"
for index, row in df_result.iterrows():
    sql_commands += f"INSERT INTO gia_du_doan (MaSP, GiaBanDuDoan) VALUES ('{row['MaSP']}', {row['GiaBanDuDoan']});\n"

# LÆ°u ná»™i dung vÃ o file .sql
ten_file_sql = 'gia_ban_du_doan.sql'
with open(ten_file_sql, 'w') as f:
    f.write(sql_commands)

print(f"\nÄÃ£ lÆ°u giÃ¡ bÃ¡n dá»± Ä‘oÃ¡n vÃ o file SQL: '{ten_file_sql}'")

